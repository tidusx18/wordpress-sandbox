!function(t,e){"use strict";t(function(){function s(s,i,n,o){return o=void 0!==o?o:{},n=void 0!==n?n:{},n.action=s,n.mphb_nonce=e.nonces.hasOwnProperty(s)?e.nonces[s]:"",o=t.extend(o,{url:e.ajaxUrl,dataType:"json",data:n,success:function(t,e,s){var n=!0===t.success,o=t.data||{};i(n,o)}}),t.ajax(o)}e.ControlButton=can.Control.extend({},{inSuspended:!1,wasDisabled:!1,defaultText:"",actionText:"",ajaxAction:"",importer:null,init:function(t,e){this.defaultText=e.defaultText,this.actionText=e.actionText,this.ajaxAction=e.ajaxAction,this.importer=e.importer},click:function(t,e){if(this.inSuspended)return!1;this.doAction()},doAction:function(){},activate:function(){this.inSuspended=!0,this.element.prop("disabled",!0),this.element.text(this.actionText)},enable:function(){this.isSuspended=!1,this.element.prop("disabled",!1),this.element.text(this.defaultText)},disable:function(){this.isSuspended=!1,this.element.prop("disabled",!0),this.element.text(this.defaultText)},suspend:function(){this.inSuspended=!0,this.wasDisabled=!!this.element.prop("disabled"),this.element.prop("disabled",!0)},restore:function(){this.isSuspended=!1,this.element.prop("disabled",this.wasDisabled)}}),e.AbortButton=e.ControlButton.extend({},{doAction:function(){this.activate(),this.importer.stop();var t=this;s(t.ajaxAction,function(e,s){t.importer.start(),e||t.enable()},{},{method:"POST"})}}),e.ClearAllButton=e.ControlButton.extend({},{doAction:function(){this.activate(),this.importer.stop(),this.importer.trigger("mphb:clear_all:before");var t=this;s(this.ajaxAction,function(e,s){e?(t.importer.trigger("mphb:clear_all"),t.disable()):(t.importer.trigger("mphb:clear_all:failed"),t.enable()),t.importer.start()},{},{method:"POST"})}}),e.DetailsTableRoom=can.Control.extend({},{key:"",status:"wait",statusEl:null,totalEl:null,succeedEl:null,failedEl:null,skippedEl:null,logsWrapper:null,logsEl:null,oldStatusClass:"",emptyValuePlaceholder:"&#8212;",init:function(e,s){this.key=e.attr("data-item-key"),this.status=e.attr("data-sync-status"),this.statusEl=e.find(".column-status > span"),this.totalEl=e.find(".column-total"),this.succeedEl=e.find(".column-succeed"),this.failedEl=e.find(".column-errors, .column-failed"),this.skippedEl=e.find(".column-skipped"),this.logsWrapper=t('[data-item-key="'+this.key+'"] + .mphb-logs-wrapper'),this.logsEl=this.logsWrapper.find("td"),this.oldStatusClass=this.statusEl.attr("class")},".mphb-expand-item click":function(t,e){e.preventDefault(),t.blur(),this.logsWrapper.toggleClass("hidden")},showLogs:function(){this.logsWrapper.removeClass("hidden")},hideLogs:function(){this.logsWrapper.addClass("hidden")},changeContent:function(t){this.status=t.status.value,this.element.attr("data-sync-status",t.status.value),this.statusEl.removeClass(this.oldStatusClass).addClass(t.status.class),this.oldStatusClass=t.status.class,void 0==t.progress?this.statusEl.text(t.status.text):this.statusEl.text(t.status.text+" ("+t.progress+"% )"),0!=t.stats.total?this.totalEl.text(t.stats.total):this.totalEl.html(this.emptyValuePlaceholder),0!=t.stats.succeed?this.succeedEl.text(t.stats.succeed):this.succeedEl.html(this.emptyValuePlaceholder),0!=t.stats.failed?this.failedEl.text(t.stats.failed):this.failedEl.html(this.emptyValuePlaceholder),0!=t.stats.skipped?this.skippedEl.text(t.stats.skipped):this.skippedEl.html(this.emptyValuePlaceholder),t.stats.failed>0&&this.element.addClass("mphb-have-errors"),this.logsEl.html(t.logs)},clear:function(){this.element.remove(),this.logsWrapper.remove()},getKey:function(){return this.key},getStatus:function(){return this.status}}),e.DetailsTable=can.Control.extend({},{itemsSinguralText:"%d item",itemsPluralText:"%d items",ajaxAction:"",importer:null,rooms:{},roomsCount:0,roomsCountEl:null,init:function(t,e){this.itemsSinguralText=e.itemsSinguralText,this.itemsPluralText=e.itemsPluralText,this.ajaxAction=e.ajaxAction,this.importer=e.importer,this.initRooms(),this.initRemoveButtons(),this.roomsCountEl=t.parent().find(".displaying-num")},initRooms:function(){var s=this.element.find("tbody > tr:not(.mphb-logs-wrapper):not(.no-items)"),i={},n=0;s.each(function(s,o){var a=new e.DetailsTableRoom(t(o)),r=a.getKey();i[r]=a,n++}),this.rooms=i,this.roomsCount=n},initRemoveButtons:function(){var e=this;this.element.find(".mphb-remove-item").addClass("mphb-inited").on("click",function(s){s.preventDefault(),s.stopPropagation();var i=t(this).parents("tr"),n=i.attr("data-item-key");n&&e.rooms[n]&&(t(this).prop("disabled",!0),e.removeRoomByKey(n))})},removeRoomByKey:function(t){this.importer.stop();var e=this;s(this.ajaxAction,function(s){s?e.removeRoom(e.rooms[t]):e.element.find(".mphb-remove-item:disabled").prop("disabled",!1),e.importer.start()},{mphb_room_key:t},{method:"POST"})},removeRoom:function(t){t.clear(),delete this.rooms[t.getKey()],this.roomsCount--,this.updateRoomsCount(),this.isEmpty()&&this.notifyEmpty()},clear:function(){var e=this;t.each(this.rooms,function(t,s){e.removeRoom(s)}),this.roomsCount=0},isEmpty:function(){return 0==this.roomsCount},notifyEmpty:function(){this.importer.trigger("mphb:clear_all")},changeContent:function(e){var s=this;t.each(e,function(t,e){s.rooms[e.key]&&s.rooms[e.key].changeContent(e)})},updateRoomsCount:function(){var t=1==this.roomsCount?this.itemsSinguralText:this.itemsPluralText;this.roomsCountEl.text(t.replace("%d",this.roomsCount))},getKeysByStatus:function(e){var s=[];return t.each(this.rooms,function(t,i){i.getStatus()==e&&s.push(i.getKey())}),s},showLogs:function(){t.each(this.rooms,function(t,e){e.showLogs()})},hideLogs:function(){t.each(this.rooms,function(t,e){e.hideLogs()})}}),e.ImportStats=can.Control.extend({},{totalEl:null,succeedEl:null,failedEl:null,init:function(t,e){this.totalEl=this.element.find(".mphb-total"),this.succeedEl=this.element.find(".mphb-succeed"),this.skippedEl=this.element.find(".mphb-skipped"),this.failedEl=this.element.find(".mphb-failed")},updateStats:function(t){this.totalEl.text(t.total),this.succeedEl.text(t.succeed),this.skippedEl.text(t.skipped),this.failedEl.text(t.failed)}}),e.Importer=can.Control.extend({},{tickInterval:2e3,shortTickInterval:500,retriesCount:1,retriesLeft:0,inProgress:!1,updateTimeout:null,preventUpdates:!1,init:function(t,e){this.inProgress=e.inProgress,this.resetRetries(),this.inProgress&&this.start()},start:function(){this.preventUpdates=!1,this.updateTimeout=setTimeout(this.tick.bind(this),this.shortTickInterval)},requestUpdate:function(){this.preventUpdates=!1,this.updateTimeout=setTimeout(this.tick.bind(this),this.tickInterval)},stop:function(){clearTimeout(this.updateTimeout),this.preventUpdates=!0},resetRetries:function(){this.retriesLeft=this.retriesCount},markInProgress:function(){this.inProgress=!0},markStopped:function(){this.inProgress=!1},trigger:function(t){this.element.trigger(t)}}),e.LogsHandler=can.Control.extend({},{shown:0,insertLogs:function(t){this.element.append(t)},setShown:function(t){this.shown=t}}),e.ProgressBar=can.Control.extend({},{barEl:null,textEl:null,init:function(t,e){this.barEl=this.element.find(".mphb-progress__bar"),this.textEl=this.element.find(".mphb-progress__text")},updateProgress:function(t){this.barEl.css("width",t+"%"),this.textEl.text(t+"%")}}),e.SyncImporter=e.Importer.extend({},{abortButton:null,clearAllButton:null,detailsTable:null,init:function(t,s){this._super(t,s),this.detailsTable=new e.DetailsTable(this.element.find(".mphb-ical-sync-table"),{itemsSinguralText:e.i18n.items_singular,itemsPluralText:e.i18n.items_plural,ajaxAction:e.actions.sync.remove_item,importer:this}),this.abortButton=new e.AbortButton(this.element.find(".mphb-abort-process"),{defaultText:e.i18n.abort,actionText:e.i18n.aborting,ajaxAction:e.actions.sync.abort,importer:this}),this.clearAllButton=new e.ClearAllButton(this.element.find(".mphb-clear-all"),{defaultText:e.i18n.clear,actionText:e.i18n.clearing,ajaxAction:e.actions.sync.clear_all,importer:this})},tick:function(){var t=this,i=this.detailsTable.getKeysByStatus("done");s(e.actions.sync.progress,function(e,s){if(!t.preventUpdates){if(!e)return void(t.retriesLeft>0?(t.retriesLeft--,t.requestUpdate()):t.abortButton.disable());t.resetRetries(),s.inProgress?t.markInProgress():t.markStopped(),t.detailsTable.changeContent(s.items),t.inProgress?t.requestUpdate():t.abortButton.disable()}},{skip:i},{method:"POST"})},"mphb:clear_all":function(){this.abortButton.disable(),this.clearAllButton.disable(),this.detailsTable.clear()},"mphb:clear_all:before":function(){this.abortButton.suspend()},"mphb:clear_all:failed":function(){this.abortButton.restore()},".mphb-expand-all click":function(t,e){this.detailsTable.showLogs()},".mphb-collapse-all click":function(t,e){this.detailsTable.hideLogs()}}),e.UploadImporter=e.Importer.extend({},{progressBar:null,logsHandler:null,importStats:null,init:function(t,s){this._super(t,s),this.progressBar=new e.ProgressBar(this.element.find(".mphb-progress")),this.logsHandler=new e.LogsHandler(this.element.find(".mphb-logs")),this.importStats=new e.ImportStats(this.element.find(".mphb-import-stats")),this.abortButton=new e.AbortButton(this.element.find(".mphb-abort-process"),{defaultText:e.i18n.abort,actionText:e.i18n.aborting,ajaxAction:e.actions.upload.abort,importer:this})},tick:function(){var i=this;s(e.actions.upload.progress,function(e,s){if(!e)return void(i.retriesLeft>0?(i.retriesLeft--,i.requestUpdate()):i.abortButton.disable());i.resetRetries(),s.isFinished?i.markStopped():i.markInProgress(),i.importStats.updateStats(s),i.progressBar.updateProgress(s.progress),i.logsHandler.setShown(s.logsShown),i.logsHandler.insertLogs(s.logs),t(s.notice).insertAfter(".wp-heading-inline"),i.inProgress?i.requestUpdate():i.abortButton.disable()},{logsShown:i.logsHandler.shown})}});var i=t(".mphb-sync-details-wrapper");i.length&&new e.SyncImporter(i,{inProgress:e.inProgress});var n=t(".mphb-upload-import-details-wrapper");n.length&&new e.UploadImporter(n,{inProgress:e.inProgress})})}(jQuery,MPHB_iCal);